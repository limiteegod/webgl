var async = require('async');
var prop = require('config').prop;
var esdb = require('easy_db');
var Database = esdb.Database;
var Table = esdb.Table;
var Column = esdb.Column;

var esut = require('easy_util');
var log = esut.log;

var DbCenter = function(){
    var self = this;
};

DbCenter.prototype.init = function(cb)
{
    var self = this;
    esdb.log.setShowLog(true);
    async.waterfall([
        //the mysql
        function(cb){
            self._initMain(function(err){
                cb(err);
            });
        },
        //the mongodb
        function(cb){
            self._initMg(function(err){
                cb(err);
            });
        }
        ,
        //the mongodb 消息库
        function(cb){
            self._initMgMsg(function(err){
                cb(err);
            });
        }
    ], function (err, result) {
        cb(err);
    });
};

DbCenter.prototype.check = function(cb)
{
    var self = this;
    async.waterfall([
        //check the mysql
        function(cb){
            self._checkMain(function(err){
                cb(err);
            });
        },
        //check the mongodb
        function(cb){
            self._checkMg(function(err){
                cb(err);
            });
        }
    ], function (err, result) {
        cb(err);
    });
};

DbCenter.prototype._initMg = function(cb)
{
    var self = this;
    var db = new Database(prop.dbs[0]);

    //add tables
    var uniqueIdTable = new Table(db, "uniqueId", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false)
    ]);
    db.put(uniqueIdTable);
    var stInfoTable = new Table(db, "stInfo", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),
        new Column(db, "st", "varchar", 32, false, undefined),
        new Column(db, "fixSt", "varchar", 32, false, undefined),
        new Column(db, "lastActiveTime", "bigint", -1, false, undefined)
    ]);
    db.put(stInfoTable);
    var account = new Table(db, "account", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),
        new Column(db, "balance", "bigint", -1, false, undefined),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(account);
    var moneylog = new Table(db, "moneylog", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),
        new Column(db, "roleId", "varchar", 20, false, undefined),
        new Column(db, "accountId", "varchar", 20, false, undefined),
        new Column(db, "typeId", "varchar", 20, false, undefined),
        new Column(db, "subjectId", "varchar", 20, false, undefined),
        new Column(db, "createTime", "bigint", -1, false, undefined),
        new Column(db, "amount", "bigint", -1, false, undefined),
        new Column(db, "stateAfter", "bigint", -1, false, undefined),
        new Column(db, "stateBefore", "bigint", -1, false, undefined),
        new Column(db, "customerId", "varchar", 80, false, undefined),
        new Column(db, "orderId", "varchar", 80, false, undefined),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(moneylog);
    var mcp_id = new Table(db, "mcp_id", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),
        new Column(db, "value", "bigint", -1, false, undefined),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(mcp_id);
    var relation = new Table(db, "relation", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),
        new Column(db, "customerId", "varchar", 80, false, undefined),
        new Column(db, "gameCode", "varchar", 80, false, undefined),
        new Column(db, "relayTo", "varchar", 80, false, undefined),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(relation);
    var printqueen = new Table(db, "printqueen", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),
        new Column(db, "printId", "varchar", 40, false, undefined),    //出票用户
        new Column(db, "gameCode", "varchar", 20, false, undefined),    //游戏
        new Column(db, "termCode", "varchar", 40, false, undefined),    //期次
        new Column(db, "pType", "varchar", 10, false, undefined),    //玩法
        new Column(db, "bType", "varchar", 10, false, undefined),    //投注方式
        new Column(db, "status", "int", 11, false, -1), //状态
        new Column(db, "multiple", "int", 11, false, 1), //倍数
        new Column(db, "amount", "bigint", -1, false, 0),     //金额
        new Column(db, "number", "varchar", 240, false, undefined),    //外部id
        new Column(db, "takeTime", "bigint", -1, false, undefined),    //外部id
        new Column(db, "version", "int", 11, false, 0)  //版本
    ]);
    db.put(printqueen);
    self.mg = db;
    self.mg.init(cb);
};

/**
 * 初始化消息库
 * @param cb
 * @private
 */
DbCenter.prototype._initMgMsg = function(cb)
{
    var self = this;
    var db = new Database(prop.dbs[2]);

    //消息
    var msg = new Table(db, "msg", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),    //消息的id
        new Column(db, "parentId", "varchar", 80, false, undefined),    //消息的父消息id
        new Column(db, "type", "int", 11, false, undefined),    //消息的类型
        new Column(db, "subCount", "int", 11, false, 0), //子消息的数目
        new Column(db, "finishCount", "int", 11, false, 0), //子消息的数目
        new Column(db, "version", "int", 11, false, 0),
        new Column(db, "status", "int", 11, false, undefined),   //消息的状态
        new Column(db, "seq", "int", 11, false, undefined),   //子消息的序号
        new Column(db, "createTime", "bigint", -1, false, undefined),   //创建时间
        new Column(db, "finishTime", "bigint", -1, false, undefined)   //创建时间
    ]);
    db.put(msg);
    //消息内容
    var detail_term = new Table(db, "detail_term", [
        new Column(db, "_id", "varchar", 80, false, undefined, true, false),
        new Column(db, "msgId", "varchar", 80, false, undefined),
        new Column(db, "gameCode", "varchar", 20, false, undefined),
        new Column(db, "code", "varchar", 40, false, undefined),
        new Column(db, "nextCode", "varchar", 40, false, undefined),
        new Column(db, "status", "int", 11, false, -1),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(detail_term);
    self.mg_msg = db;
    self.mg_msg.init(cb);
}

DbCenter.prototype._checkMg = function(cb)
{
    var self = this;
    var kvTable = self.mg.get("mcp_id");
    kvTable.findOne({_id:"orderId"}, {}, [], function(err, data){
        if(err)
        {
            cb(err);
            return;
        }
        if(!data)
        {
            kvTable.save({_id:"orderId", value:1}, [], function(err, data){
                cb(err);
            });
        }
        else
        {
            cb(null);
        }
    });
};

DbCenter.prototype._checkMain = function(cb)
{
    var self = this;
    cb(null);
};

DbCenter.prototype._initMain = function(cb)
{
    var self = this;
    var db = new Database(prop.dbs[1]);
    var torder = new Table(db, "torder", [
        new Column(db, "id", "bigint", -1, false, undefined, true, false),
        new Column(db, "createTime", "date", -1, false, undefined), //创建时间
        new Column(db, "amount", "bigint", -1, false, 0),   //订单金额
        new Column(db, "status", "int", 11, false, -1),     //状态
        new Column(db, "customerId", "varchar", 40, false, undefined),
        new Column(db, "version", "int", 11, false, 0)      //版本
    ]);
    db.put(torder);
    var tticket = new Table(db, "tticket", [
        new Column(db, "id", "bigint", -1, false, undefined, true, true),
        new Column(db, "outerId", "varchar", 40, false, undefined),    //外部id
        new Column(db, "customerId", "varchar", 40, false, undefined),    //所属用户
        new Column(db, "printId", "varchar", 40, false, undefined),    //出票用户
        new Column(db, "gameCode", "varchar", 20, false, undefined),    //游戏
        new Column(db, "termCode", "varchar", 40, false, undefined),    //期次
        new Column(db, "pType", "varchar", 10, false, undefined),    //玩法
        new Column(db, "bType", "varchar", 10, false, undefined),    //投注方式
        new Column(db, "createTime", "date", -1, false, undefined), //创建时间
        new Column(db, "status", "int", 11, false, -1), //状态
        new Column(db, "printStatus", "int", 11, false, -1), //出票状态
        new Column(db, "multiple", "int", 11, false, 1), //倍数
        new Column(db, "amount", "bigint", -1, false, 0),     //金额
        new Column(db, "bonus", "bigint", -1, false, 0),     //税后奖金
        new Column(db, "bonusDetail", "varchar", 200, false, 0),     //税后奖金
        new Column(db, "number", "varchar", 240, false, undefined),    //外部id
        new Column(db, "bonusBeforeTax", "bigint", -1, false, 0),     //税前奖金
        new Column(db, "orderId", "bigint", -1, false, undefined),     //订单号
        new Column(db, "version", "int", 11, false, 0)  //版本
    ]);
    db.put(tticket);
    var term = new Table(db, "term", [
        new Column(db, "id", "varchar", 80, false, undefined, true, false),
        new Column(db, "gameCode", "varchar", 20, false, undefined),
        new Column(db, "code", "varchar", 40, false, undefined),
        new Column(db, "nextCode", "varchar", 40, false, undefined),
        new Column(db, "openTime", "date", -1, false, undefined),
        new Column(db, "closeTime", "date", -1, false, undefined),
        new Column(db, "status", "int", 11, false, -1),
        new Column(db, "pool", "bigint", 11, false, -1),
        new Column(db, "wNum", "varchar", 80, false, undefined),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(term);
    var customer = new Table(db, "customer", [
        new Column(db, "id", "varchar", 32, false, undefined, true, false),
        new Column(db, "password", "varchar", 40, false, undefined),
        new Column(db, "type", "int", 11, false, 0),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(customer);
    var operation = new Table(db, "operation", [
        new Column(db, "id", "varchar", 40, false, undefined, true, false),
        new Column(db, "userType", "int", 11, false, undefined),
        new Column(db, "hasChildren", "int", 11, false, 0),
        new Column(db, "name", "varchar", 20, false, undefined),
        new Column(db, "parent", "varchar", 40, false, ''),
        new Column(db, "url", "varchar", 80, false, undefined),
        new Column(db, "status", "int", 11, false, 1),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(operation);
    var gamegrade = new Table(db, "gamegrade", [
        new Column(db, "id", "bigint", -1, false, undefined, true, true),
        new Column(db, "name", "varchar", 20, false, undefined),
        new Column(db, "gameCode", "varchar", 40, false, undefined),
        new Column(db, "termCode", "varchar", 40, false, undefined),
        new Column(db, "level", "int", 11, false, 0),
        new Column(db, "bonus", "bigint", -1, false, 0),
        new Column(db, "count", "bigint", -1, false, 0),
        new Column(db, "version", "int", 11, false, 0)
    ]);
    db.put(gamegrade);
    self.main = db;
    self.main.init(cb);
};

module.exports = new DbCenter();

